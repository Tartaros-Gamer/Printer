package com.reliableplugins.printer.listeners;

import com.reliableplugins.printer.Printer;
import com.reliableplugins.printer.config.Message;
import com.reliableplugins.printer.type.PrinterPlayer;
import com.reliableplugins.printer.utils.BukkitUtil;
import org.bukkit.entity.ItemFrame;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.event.entity.EntitySpawnEvent;
import org.bukkit.event.entity.ItemSpawnEvent;
import org.bukkit.event.inventory.ClickType;
import org.bukkit.event.inventory.InventoryCreativeEvent;
import org.bukkit.event.inventory.InventoryOpenEvent;
import org.bukkit.event.player.PlayerArmorStandManipulateEvent;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.event.player.PlayerInteractEntityEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.PlayerInventory;

public class ListenPrinterExploit implements Listener
{
    @EventHandler
    public void onPlayerDropItem(PlayerDropItemEvent event)
    {
        if(Printer.INSTANCE.printerPlayers.containsKey(event.getPlayer()))
        {
            PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(event.getPlayer());
            if(player.isPrinting())
            {
                event.setCancelled(true);
                player.getPlayer().sendMessage(Message.ERROR_DROP_ITEM_EXPLOIT.getMessage());
            }
        }
    }

    @EventHandler
    public void onInventoryOpen(InventoryOpenEvent event)
    {
        if(event.getPlayer() instanceof Player && !(event.getInventory() instanceof PlayerInventory))
        {
            Player ePlayer = (Player) event.getPlayer();
            if(Printer.INSTANCE.printerPlayers.containsKey(ePlayer))
            {
                PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(ePlayer);
                if(player.isPrinting())
                {
                    event.setCancelled(true);
                    ePlayer.sendMessage(Message.ERROR_INVENTORY_OPEN_EXPLOIT.getMessage());
                }
            }
        }
    }

    @EventHandler
    public void onPlayerInteractEntity(PlayerInteractEntityEvent event)
    {
        if(event.getRightClicked() instanceof ItemFrame)
        {
            if(Printer.INSTANCE.printerPlayers.containsKey(event.getPlayer()))
            {
                PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(event.getPlayer());
                if(player.isPrinting())
                {
                    event.setCancelled(true);
                    player.getPlayer().sendMessage(Message.ERROR_ITEM_FRAME_EXPLOIT.getMessage());
                }
            }
        }
    }

    @EventHandler
    public void onPlayerInteract(PlayerInteractEvent event)
    {
        // Allow itemblocks like DIODE, COMPARATOR, etc...
        if(event.getItem() != null && !event.getItem().getType().isBlock()
                && Printer.INSTANCE.printerPlayers.containsKey(event.getPlayer()))
        {
            PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(event.getPlayer());

            if (player.isPrinting())
            {
                Double price = Printer.INSTANCE.getPricesConfig().getItemPrices().get(event.getItem().getType());
                if(price == null)
                {
                    event.setCancelled(true);
                    event.getPlayer().sendMessage(Message.ERROR_BLOCK_NOT_ALLOWED.getMessage());
                }
                else if(!Printer.INSTANCE.withdrawMoney(player.getPlayer(), price))
                {
                    event.setCancelled(true);
                }
            }
        }
    }

    @EventHandler
    public void onInventoryCreative(InventoryCreativeEvent event)
    {
        if(event.getClick().equals(ClickType.CREATIVE))
        {
            System.out.println("kb: "  + ClickType.CREATIVE.isKeyboardClick());
            System.out.println("s: " + ClickType.CREATIVE.isShiftClick());
            System.out.println("l: " + ClickType.CREATIVE.isLeftClick());
            System.out.println("r: " + ClickType.CREATIVE.isRightClick());
        }
    }

    @EventHandler
    public void onArmorStandEdit(PlayerArmorStandManipulateEvent event)
    {
        if(Printer.INSTANCE.printerPlayers.containsKey(event.getPlayer()))
        {
            PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(event.getPlayer());
            if(player.isPrinting())
            {
                event.setCancelled(true);
                player.getPlayer().sendMessage(Message.ERROR_ARMOR_STAND_EXPLOIT.getMessage());
            }
        }
    }

    @EventHandler
    public void OnEntityDamageByEntity(EntityDamageByEntityEvent event)
    {
        if(event.getDamager() instanceof Player)
        {
            Player ePlayer = (Player) event.getDamager();
            if(Printer.INSTANCE.printerPlayers.containsKey(ePlayer))
            {
                PrinterPlayer player = Printer.INSTANCE.printerPlayers.get(ePlayer);
                if(player.isPrinting())
                {
                    player.printerOff();
                    player.getPlayer().sendMessage(Message.ERROR_DAMAGE_EXPLOIT.getMessage());
                }
            }
        }
    }
}
